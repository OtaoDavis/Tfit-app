workflows:
  ios-capacitor-dev:
    name: iOS Build (signed)
    environment:
      node: 22.15.0
      xcode: latest
      cocoapods: default
      groups:
        - firebase
        - kajabi
        - signing
      vars:
        DEVELOPMENT_TEAM: "X3L24943PL" 
    scripts:
      - name: Install dependencies
        script: |
          npm ci
          npm run build

      - name: Capacitor Sync
        script: |
          npx cap sync ios
          npx cap copy ios
          gem install cocoapods
          cd ios/App && pod install
          
      - name: Use Xcode managed signing
        script: |
          xcode-project use-profiles --project ios/App/App.xcodeproj \
            --target "App" \
            --bundle-id com.treasurefitness.com \
            --team-id X3L24943PL

      - name: Build iOS app (signed)
        script: |
          cd ios/App
          xcodebuild -workspace App.xcworkspace \
                     -scheme App \
                     -configuration Release \
                     -sdk iphoneos \
                     -archivePath $CM_BUILD_DIR/App.xcarchive \
                     archive
      
          xcodebuild -exportArchive \
                     -archivePath $CM_BUILD_DIR/App.xcarchive \
                     -exportPath $CM_BUILD_DIR/build \
                     -exportOptionsPlist ExportOptions.plist

    artifacts:
      - build/**/*.ipa
      - ios/App/build/**/*.app


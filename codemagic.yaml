workflows:
  ios-capacitor-testflight:
    name: iOS TestFlight Build
    environment:
      node: 22.15.0
      xcode: latest
      cocoapods: default
      vars:
        DEVELOPMENT_TEAM: "X3L24943PL" 
        BUNDLE_ID: "com.treasurefitness.com"
      groups:
        - firebase
    integrations:
      app_store_connect: admin_key 

    scripts:
      - name: Install dependencies
        script: |
          npm ci
          npm run build

      - name: Capacitor Sync and Pod Install
        script: |
          npx cap sync ios
          cd ios/App && pod install

      - name: Code Signing Setup 
        script: |
          keychain initialize

          # --- REMOVED: app-store-connect fetch-signing-files ---
          # With manual code signing, Codemagic will make the uploaded .p12 and .mobileprovision
          # files available in the build environment automatically.
          # The 'keychain initialize' sets up the keychain where these will be placed.

          # Change to the directory where your Xcode project/workspace resides
          # This is still important for 'xcode-project use-profiles' to find the project correctly.
          cd ios/App

          # Use profiles. This step should properly apply the development team and signing settings.
          # It will now use the provisioning profiles uploaded to Codemagic.
          # No --workspace or --scheme arguments needed for use-profiles.
          xcode-project use-profiles

          # Change back to the root directory for subsequent commands
          cd ../..

      - name: Build and export iOS app
        script: |
          XCARCHIVE_PATH="${CM_BUILD_DIR}/App.xcarchive"

          echo "Archiving project..."
          xcodebuild -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "${XCARCHIVE_PATH}" \
            archive || exit 1

          echo "Exporting IPA using Codemagic CLI..."
          cd "${CM_BUILD_DIR}" # Ensure we are in the root directory for xcode-project build-ipa

          xcode-project build-ipa \
            --archive-path "${XCARCHIVE_PATH}" \
            --workspace ios/App/App.xcworkspace \
            --scheme App \
            --ipa-directory build/ios/ipa

    artifacts:
      - build/**/*.ipa